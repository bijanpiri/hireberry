<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <script src="bootstrap/tagsinput/bootstrap-tagsinput.js"></script>
    <link rel="stylesheet" href="bootstrap/tagsinput/bootstrap-tagsinput.css">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyB9JJKEbOztuSVauWEU58UeQJWtuzip2eU&sensor=false"></script>
    <script src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markermanager/src/markermanager.js"></script>
    <script>
        var map;
        var mycenter;
        var boards = [];
        var markers;
        var markersarray=[];
        var infowindow;
        var boardname;
        var titleaddtotagslist;
        var markercolor;
        var boardidtotags;
        var items=[];
        var idarray=[];
        var removedvalue;
        function initialize(){
            var map_property = {
                center: new google.maps.LatLng(51.508742,-0.120850),
                zoom: 5,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById('map-canvas'),map_property);
            getLocation();

        }
        function getLocation(){
            markers = new MarkerManager(map);
            $.getJSON('/board/public',function(publicBoards){
                $.each(publicBoards,function(index,board){
                    if(board.locationlat && board.locationlng){
                        boards.push(board);
                        var marker = new google.maps.Marker({
                            type:'Feature',
                            icon:'http://maps.google.com/mapfiles/ms/icons/purple-dot.png',
                            position: new google.maps.LatLng(board.locationlat,board.locationlng),
                            map: map,
                            'result':[{"address_components":[{
                                'title':board.name,
                                'boardIndex':index,
                                'description':board.category,
                                'icon':{
                                    'size':new google.maps.Size(32,32),
                                    'color':'522'
                                }

                            }]
                            }]

                        });
                        marker.title=board.name;
                        marker.boardid=board._id;
                        markers.addMarker(marker);
                        markersarray.push(marker);
                    }

                    items.push({value:board._id,text:board.name,marker:marker});
                });

                markers.refresh();
                try{
                    $.each(markersarray,function(index,marker){
                        google.maps.event.addListener(marker,'click',function(e){
                            titleaddtotagslist = marker.title;
                            boardidtotags = marker.boardid;
                            idarray=$('#tags-input').val().split(',');
                            var flag=false;

                                for(var i=0;i<idarray.length;i++){
                                    if(idarray[i]==boardidtotags ){
                                        removedvalue=boardidtotags;
                                        $('#tags-input').tagsinput('remove',{value:boardidtotags});
                                        marker.setIcon('http://maps.google.com/mapfiles/ms/icons/purple-dot.png');
                                        flag=true;
                                    }
                                }
                            if(flag==false){
                                 $('#tags-input').tagsinput('add',{"value":boardidtotags,"text":titleaddtotagslist,marker:marker});
                                    marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');

                            }

                        });
                    });
                    $("#tags-input").on('itemAdded', function(event) {
                        event.item.marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
                    });
                    $("#tags-input").on('itemRemoved', function(event) {
                        event.item.marker.setIcon('http://maps.google.com/mapfiles/ms/icons/purple-dot.png');
                    });

                    markers.setMap(map);

                }catch (e){
                    console.log(e);
                }
            });

        }
        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
    <script>
        $(document).ready(function(){
            $('#tags-input').tagsinput({
                itemValue: function (item) {
                    return item.value;
                },
                itemText: function (item) {
                    return item.text;
                },
                typeahead:{
                    source:items
                }
            });
            /*for(var i=0;i<idarray.length;i++){
                if(idarray[i]!==removedvalue)
                    marker.setIcon('http://maps.google.com/mapfiles/ms/icons/purple-dot.png');
            }*/

        });
    </script>
</head>
<body>
<div>
    <input id="tags-input" type="text"/>
</div>
<div id="map-canvas" style="width:500px;height:380px;"></div>
</body>
</html>