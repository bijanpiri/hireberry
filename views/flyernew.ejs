<% layout('layout') -%>


<script src="/jquery-ui/js/file_upload.js"></script>
<script src="/flyer.js"></script>
<script>
    var portletCounter = 0;
    var flyer;
    var flyerid;
    var portletStackID;

    $(function() {
        flyer = new Flyer(true);

        flyerid = $('input[name=flyerid]').val();
        portletStackID = 'portletStack';

        flyer.initPortlet( $('#' + portletStackID) );
        flyer.loadLastFlyer( flyerid, portletStackID );

        $( ".column" ).sortable({
            connectWith: ".column"
        }).disableSelection();

        $(".newitem").click(function(e){
            var itemType = $(this).attr('type');
            var itemID = portletCounter++;
            var portletType = flyer.portletTypeString2Type(itemType);

            flyer.createPortlet( portletType, itemID, null, portletStackID );
        });

        var previewWindow = 0;

        $('#buttonPreview').click( function() {

            var flyerid = $('input[name=flyerid').val();

            if( previewWindow==0 )
                previewWindow = window.open('/flyer/' + flyerid);
            else
                previewWindow.location = '/flyer/' + flyerid;
        })

        $('#buttonSave').click(function(){
            var flyerjson = flyer.flyer2json('portletStack');

            $('#buttonSave').text('Saving...').addClass('disabled');

            $.post( '/flyer/new', {flyer:flyerjson} )
                    .done(function(data){
                        $('#buttonSave').text('Save').removeClass('disabled');
                    })
                    .fail(function(data){
                        $('#buttonSave').text('Save*').removeClass('disabled');
                    });

            console.log( flyer );
        });

        $('#buttonCreate').click(function(){
            $('#buttonSave').click();
        });
    });
</script>

<link rel="stylesheet" href="/gridster/jquery.gridster.min.css">
<script src="/gridster/jquery.gridster.min.js"></script>
<script>
    var isDraggingSpliter = false;
    var isDraggingSelection = false;
    var dragingSpliter;
    var cellsState = [];

    $(function(){ //DOM Ready

        var initCellStates = function() {

            for(var r=0; r<4; r++) {
                cellsState[r] = [];
                for(var c=0; c<3; c++){
                    cellsState[r][c] = {
                        r:1,
                        l:1,
                        t:1,
                        b:1,
                        content: $('.fsheet')
                                .find('.fcolumn').eq(c)
                                .find('.frow').eq(r)
                                .find('.fcontent').first()
                    };
                }
            }
        }

        var updateSheet = function() {
            var sheetWidth = parseInt( $('.fsheet').css('width') );
            $('.fsheet').css('height', sheetWidth*0.75);
        }

        var mergeCells = function(from,to){
            var sc = from.column;
            var sr = from.row;
            var ec = to.column;
            var er = to.row;

            // Remove shared borders
            for(var c=sc; c<=ec; c++){
                for(var r=sr; r<=er; r++){
                    var cell = cellsState[r][c];

                    // Set Borders Visibility
                    cell.r = ( c==ec ? 1 : 0 );
                    cell.l = ( c==sc ? 1 : 0 );
                    cell.t = ( r==sr ? 1 : 0 );
                    cell.b = ( r==er ? 1 : 0 );

                    var borders = {
                        'border-left-style':(cell.l==1?'dotted':'none'),
                        'border-right-style':(cell.r==1?'dotted':'none'),
                        'border-top-style':(cell.t==1?'dotted':'none'),
                        'border-bottom-style':(cell.b==1?'dotted':'none')
                    }

                    cell.content.css(borders);
                    cell.content.unbind('mouseenter');
                    cell.content.unbind('mouseleave');

                    // Select the merged cells all together
                    cell.content.mouseenter(function(e){
                        for(var c=sc; c<=ec; c++)
                            for(var r=sr; r<=er; r++)
                                cellsState[c][r].content.css('background-color', $(this).css('background-color'));
                    });

                    // Unselect the merged cells all together
                    cell.content.mouseleave(function(e){
                        for(var c=sc; c<=ec; c++)
                            for(var r=sr; r<=er; r++)
                                cellsState[c][r].content.css('background-color', '');
                    });
                }
            }
        }


        initCellStates();
        mergeCells({column:1,row:1},{column:2,row:2});
        updateSheet();

        $(window).resize( function(e) {
            updateSheet();
        });

        $(document).mouseup( function(e){
            $(this).unbind('mousemove');
            isDraggingSpliter = false;
            isDraggingSelection = false;
        });

        $('.fspliter').mousedown(function(e){
            e.preventDefault();

            isDraggingSpliter = true;
            dragingSpliter = $(this);
            $(this).attr('lastX', e.pageX);

            $(document).mousemove(mouseMoveDragingSpliter);
        });

        var mouseMoveDragingSpliter = function(e){

            if( isDraggingSpliter ){
                var col1Width = parseInt( dragingSpliter.prev().css('width') );
                var col2Width = parseInt( dragingSpliter.next().css('width') );
                var spliterX = dragingSpliter.attr('lastX');

                var offset = e.pageX - spliterX;
                var newCol1Width = col1Width + offset;
                var newCol2Width = col2Width - offset
                var totalWidth = parseInt( $('.fsheet').css('width') );
                var col1WidthPercent = (100*newCol1Width/totalWidth);
                var col2WidthPercent = (100*newCol2Width/totalWidth);

                dragingSpliter.prev().css('width',col1WidthPercent + '%');
                dragingSpliter.next().css('width',col2WidthPercent + '%');

                dragingSpliter.attr('lastX', e.pageX);
            }
        }
    });
</script>

<style>
    .newitem {
        margin: 5px;
    }

    .gridster li {
        background-color: #555;
    }

    .fsheet {
        font-size: 0; /* for removing space between inline-block elements! */
        /*border: 3px dashed #888;*/
        height: 400px;
    }

    .fcolumn {
        display: inline-block;
        vertical-align: top;
        width: 30%;
        font-size: 16px;
        height: 100%;
    }

    .fspliter {
        display: inline-block;
        vertical-align: top;
        width: 2px;
        height: 100%;
    }

    .fspliter:hover {
        cursor: ew-resize;
        background-color: #ddd;
    }

    .frow {
        height: 25%;
    }

    .frow .fcontent {
        border: 1px dotted #000;
        height: 100%;
    }

    .frow .fcontent:hover {
        background-color: #fff4af;
    }

    .frow .fcontent > div {
        display: none;
        margin: 5%;
        height: 100%;
        text-align: center;
    }

    .frow .fcontent:hover > div {
        display: block;
    }

</style>

<div class="container-fluid" style="width: 95%;">
    <div class="row-fluid"><h4>Creating New Flyer</h4></div>
    <div class="row-fluid hide">
        <div>
            <div class="gridster">
                <ul>
                    <li data-row="1" data-col="1" data-sizex="1" data-sizey="1"></li>
                    <li data-row="2" data-col="1" data-sizex="1" data-sizey="1"></li>
                    <li data-row="3" data-col="1" data-sizex="1" data-sizey="1"></li>

                    <li data-row="1" data-col="2" data-sizex="2" data-sizey="1"></li>
                    <li data-row="2" data-col="2" data-sizex="2" data-sizey="2"></li>

                    <li data-row="1" data-col="4" data-sizex="1" data-sizey="1"></li>
                    <li data-row="2" data-col="4" data-sizex="2" data-sizey="1"></li>
                    <li data-row="3" data-col="4" data-sizex="1" data-sizey="1"></li>

                    <li data-row="1" data-col="5" data-sizex="1" data-sizey="1"></li>
                    <li data-row="3" data-col="5" data-sizex="1" data-sizey="1"></li>

                    <li data-row="1" data-col="6" data-sizex="1" data-sizey="1"></li>
                    <li data-row="2" data-col="6" data-sizex="1" data-sizey="2"></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span8">
            <div class="fsheet">
                <div class="fcolumn">
                    <div class="frow">
                        <div class="fcontent">
                            <div class="content-fluid">
                                <div class="row-fluid">
                                    <div class="span3">A</div>
                                    <div class="span3">B</div>
                                    <div class="span3">C</div>
                                    <div class="span3">D</div>
                                </div>
                                <div class="row-fluid">
                                    <div class="span3">A</div>
                                    <div class="span3">B</div>
                                    <div class="span3">C</div>
                                    <div class="span3">D</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="frow">
                        <div class="fcontent">
                        </div>
                    </div>
                    <div class="frow">
                        <div class="fcontent"></div>
                    </div>
                    <div class="frow">
                        <div class="fcontent"></div>
                    </div>
                </div>
                <div class="fspliter">
                    <div class="frow"></div>
                    <div class="frow"></div>
                    <div class="frow"></div>
                    <div class="frow"></div>
                </div>
                <div class="fcolumn">
                    <div class="frow">
                        <div class="fcontent"></div>
                    </div>
                    <div class="frow">
                        <div class="fcontent"></div>
                    </div>
                    <div class="frow">
                        <div class="fcontent"></div>
                    </div>
                    <div class="frow">
                        <div class="fcontent"></div>
                    </div>
                </div>
                <div class="fspliter">
                    <div class="frow"></div>
                    <div class="frow"></div>
                    <div class="frow"></div>
                    <div class="frow"></div>
                </div>
                <div class="fcolumn">
                    <div class="frow">
                        <div class="fcontent"></div>
                    </div>
                    <div class="frow">
                        <div class="fcontent"></div>
                    </div>
                    <div class="frow">
                        <div class="fcontent"></div>
                    </div>
                    <div class="frow">
                        <div class="fcontent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row-fluid" hidden>
        <div class="span3"  style="background-color: #e8eec2;">
            <form method="post" action="/flyer/new" class="form-actions" style="margin: 0 auto">
                <fieldset>
                    <div class="control-group">
                        <legend>
                            Settings
                        </legend>
                        <div class="controls">
                            <input type="hidden" name="flyerid" value="<%=flyerid%>"/>
                            <input type="text" name="flyertext" placeholder="Enter Flyer Description"/>
                            <span class="help-block">Select Template</span>
                            <select name="templates" class="form-control">
                                <option value='template01'>Landscape</option>
                                <option value='template02'>Portrait</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-group">
                        <legend>
                            Publish
                        </legend>
                        <div class="controls">
                            <span class="help-block">Select First Board For Putting Up</span>
                            <select name="board" class="form-control">
                                <% for(i=0;i<boards.length;i++){%>
                                <option value=<%=boards[i]._id%>><%=boards[i].name%></option>
                                <%}%>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" id="buttonCreate">Create</button>
                    <button type="button" class="btn btn-success" id="buttonSave">Save</button>
                    <button type="button" class="btn btn-warning" id="buttonPreview">Preview</button>
                </fieldset>
            </form>
        </div>
        <div class="span8">
            <div class="column" id="portletStack">
                <div class="portlet" id="portletCreator">
                    <div class="portlet-header">New Item</div>
                    <div class="portlet-content">
                        <div class="row-fluid text-center">
                            <div class="span1 newitem" type="picture"><i class="icon-picture"></i></div>
                            <div class="span1 newitem" type="text"><i class="icon-font"></i></div>
                            <div class="span1 newitem" type="video"><i class="icon-facetime-video"></i></div>
                            <div class="span1 newitem" type="button"><i class="icon-globe"></i></div>
                            <div class="span1 newitem" type="tag"><i class="icon-tag"></i></div>
                            <div class="span1 newitem" type="map"><i class="icon-map-marker"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="span1"  style="background-color: #e8eec2;box-shadow: 2px 2px 2px #555555;">
            <div class="container-fluid" style="padding: 0 20px;">
                <div class="row-fluid text-center">
                    <div class="span12 newitem" type="picture"><i class="icon-picture"></i></div>
                </div>
                <div class="row-fluid text-center">
                    <div class="span12 newitem" type="text"><i class="icon-font"></i></div>
                </div>
                <div class="row-fluid text-center">
                    <div class="span12 newitem" type="video"><i class="icon-facetime-video"></i></div>
                </div>
                <div class="row-fluid text-center">
                    <div class="span12 newitem" type="button"><i class="icon-globe"></i></div>
                </div>
                <div class="row-fluid text-center">
                    <div class="span12 newitem" type="tag"><i class="icon-tag"></i></div>
                </div>
                <div class="row-fluid text-center">
                    <div class="span12 newitem" type="map"><i class="icon-map-marker"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</div>
</div>
