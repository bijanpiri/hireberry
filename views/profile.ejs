<% layout('layout') -%>
<script src="flyer.js"></script>

<script>
    function showMessage(text) {
        $('.alert').find('.msg').text(text);
        $('.alert').show();
        setTimeout(function(){hideMessage()},7000);
    }

    function hideMessage() {
        $('.alert').hide();
    }

    $(function(){

        var LoadBoardsInformation = function() {

            // Load information about flyers on each board
            $('.userboard').each(function(index){

                var boardid = $(this).attr('board-id');
                var flyerInformation = $(this).find('.thumbnail .boardInformation');
                flyerInformation.html('');

                $.get('/board/'+boardid+'/flyers')
                        .done(function(data){
                            flyerInformation.append('Number Of Flyers: ' + data.flyers.length);
                        })
                        .fail(function(data){
                        });
            });
        }

        var LoadFlyersInformation = function() {
            // Load information about board of flyer
            $('.userflyer').each(function(index){

                var flyerid = $(this).attr('flyer-id');
                var boardInformation = $(this).find('.thumbnail .flyerInformation');
                boardInformation.html('');

                flyer = new Flyer();
                flyer.loadLastFlyer(flyerid,'userFlyerPreview'+flyerid)

                $.get('/flyer/'+flyerid+'/boards')
                        .done(function(data){
                            data.boards.forEach(function(board){
                                boardInformation.prepend([
                                    '<div>',
                                    board.name,
                                    '<a class="btn btn-danger" href="">',
                                    'Put Down',
                                    '</a></div>'].join(''));
                            });
                            boardInformation.prepend('Number Of Boards: ' + data.boards.length);
                        })
                        .fail(function(data){
                        });
            });
        }

        LoadBoardsInformation();
        LoadFlyersInformation();

        $('.putupform').submit(function(){

            $.post('/flyer/putup',$(this).serialize())
                    .always(function(data){
                        showMessage(data.error);

                        // ToDo: Implement More Efficient!
                        LoadBoardsInformation();
                        LoadFlyersInformation();
                    });

            return false;
        })
    });
</script>
<div class="container">
    <div class="row">
        <h2>Profile</h2>
    </div>

    <div class="alert alert-info hide">
        <span class="msg"></span>
    </div>

    <div class="row">
        <div>
            <div style="background-color: #ffffff; padding: 5px">
            </div>
            <div class="tabbable"> <!-- Only required for left/right tabs -->
                <ul class="nav nav-tabs" id="settingTabs">
                    <li class="active">
                        <a href="#tab1" data-toggle="tab">
                            Boards<span class="badge"><%= boards.length %></span>
                        </a>
                    </li>
                    <li>
                        <a href="#tab2" data-toggle="tab">
                            Flyers<span class="badge"><%= flyers.length %></span>
                        </a>
                    </li>
                    <li>
                        <a href="#tab3" data-toggle="tab">
                            Following<span class="badge"><%= followingBoards.length %></span>
                        </a>
                    </li>
                    <li>
                        <a href="#tab4" data-toggle="tab">
                            Ticketeds<span class="badge"><%= ticketedFlyers.length %></span>
                        </a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="tab1">
                        <div>
                            <ul class="thumbnails">
                                <% for(i=0;i<boards.length;i++){%>
                                <li class="span3 userboard" board-id="<%=boards[i]._id%>">
                                    <a class="thumbnail" href="/board/<%=boards[i]._id%>">
                                        <h3 class="caption"><%=boards[i].name%></h3>
                                        <h5 class="caption"><%=boards[i].category%></h5>
                                        <h5 class="caption"><%=boards[i].privacy||''%></h5>
                                        <h5 class="boardInformation"></h5>
                                    </a>
                                </li>
                                <%}%>
                            </ul>
                        </div>
                    </div>
                    <div class="tab-pane" id="tab2">
                        <div>
                            <ul class="thumbnails">
                                <% for(var i=0;i<flyers.length;i++){%>
                                <li class="span5 userflyer" flyer-id="<%=flyers[i]._id%>">
                                    <div class="thumbnail">
                                        <a href="/flyer/<%=flyers[i]._id%>">
                                            <div class="container-fluid">
                                                <div class="row-fluid">

                                                    <div class="span11">
                                                        <h4>
                                                            <%=(flyers[i].flyer&&flyers[i].flyer.description)
                                                                    ? flyers[i].flyer.description
                                                                    : "untitled"%>
                                                        </h4>
                                                    </div>
                                                    <div class="span1">
                                                        <a class="btn" href="/flyer/remove/<%=flyers[i]._id%>">&times</a>
                                                    </div>
                                                </div>
                                                <div class="flyerInformation"></div>
                                                <div class="row-fluid">

                                                    <form action="/flyer/putup" method="post" class="form-inline putupform">
                                                        <div class="controls">

                                                            <input type="hidden" name="flyerid" value="<%=flyers[i]._id%>">
                                                            <select name="boardid">
                                                                <%for(var j=0;j<pBoards.length;j++){%>
                                                                <option value="<%=pBoards[j]._id%>"> <%=pBoards[j].name%> </option>
                                                                <%}%>
                                                            </select>
                                                            <button class="btn input-mini btn-danger" type="submit">pin it</button>

                                                        </div>
                                                    </form>

                                                    <hr style="background-color: #000000;height: 1px">
                                                </div>
                                                <div class="row-fluid">

                                                    <div id="userFlyerPreview<%=flyers[i]._id%>"></div>
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                </li>
                                <%}%>
                            </ul>
                        </div>
                    </div>
                    <div class="tab-pane" id="tab3">
                        <div>
                            <ul class="thumbnails">
                                <% for(i=0;i<followingBoards.length;i++){%>
                                <li class="span3">
                                    <a class="thumbnail" href="/board/<%=followingBoards[i]._id%>">
                                        <h3 class="caption"><%=followingBoards[i].name%></h3>
                                        <h5 class="caption"><%=followingBoards[i].category%></h5>
                                        <h5 class="caption"><%=followingBoards[i].privacy||''%></h5>
                                    </a>
                                </li>
                                <%}%>
                            </ul>
                        </div>
                    </div>
                    <div class="tab-pane" id="tab4">
                        <div>
                            <ul class="thumbnails">
                                <% for(i=0;i<ticketedFlyers.length;i++){%>
                                <li class="span3">
                                    <% if( ticketedFlyers[i].isDeleted) { %>
                                    <h3 class="caption">A Deleted Flyer</h3>
                                    <% } else { %>
                                    <a class="thumbnail" href="/flyer/<%=ticketedFlyers[i].flyer._id%>">
                                        <h3 class="caption"><%=ticketedFlyers[i].flyer.flyer.description%></h3>
                                    </a>
                                    <% } %>
                                </li>
                                <%}%>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
