<% layout('layout') -%>
<script>
    var boardsIsHidden = true;
    var flyersIsHidden = true;

    function showMessage(text) {
        $('.alert').find('.msg').text(text);
        $('.alert').show();
    }

    function hideMessage() {
        $('.alert').hide();
    }

    $(function(){
        $('#saveButton').click(function(){
            var datastring= $("#passwordChangingForm").serialize();
            $.ajax({
                url: '/profile',
                type: 'post',
                dataType: 'json',
                data: datastring,
                error: function(data){
                    if(data.status != 200)
                        showMessage('Invalid Email Or Password.');
                    else
                        showMessage('Saved Successfully');
                },
                success: function(data){
                    showMessage('Saved Successfully');
                }
            });

        });

        // Load information about flyers on each board
        $('.userboard').each(function(index){

            var boardid = $(this).attr('board-id');
            var thumbnail = $(this).find('.thumbnail');

            $.get('/board/'+boardid+'/flyers')
                    .done(function(data){
                        thumbnail.append('Number Of Flyers: ' + data.flyers.length);
                    })
                    .fail(function(data){
                    });
        })

        // Load information about board of flyer
        $('.userflyer').each(function(index){

            var flyerid = $(this).attr('flyer-id');
            var thumbnail = $(this).find('.thumbnail');

            $.get('/flyer/'+flyerid+'/boards')
                    .done(function(data){
                        thumbnail.append('Number Of Boards: ' + data.boards.length);
                    })
                    .fail(function(data){
                    });
        })
    });
</script>
<div class="container">
    <div class="row">
        <h2>Profile</h2>
    </div>

    <div class="alert alert-info hide">
        <button class="close" data-dismiss="alert">
            &times;
        </button>
        <span class="msg">Invalid Email or password</span>
    </div>

    <div class="row">
        <form class="form-horizontal" action="/profile" method="post" id="passwordChangingForm">
            <div class="control-group">
                <div class="control-label"> Email:</div>
                <div class="controls ">
                    <%=everyauth.user.email%>
                </div>
            </div>

            <div class="control-group">
                <div class="control-label"> Enter Old Password:</div>
                <div class="controls ">
                    <div class="input-prepend input-append">
                        <input type="password"  name="oldpassword" placeholder="Enter password">
                    </div>
                    <label class="help-inline">Passwords must match</label>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label"> Enter New Password:</div>
                <div class="controls ">
                    <div class="input-prepend input-append">
                        <input type="password"  name="newpassword" placeholder="Enter password">
                    </div>
                    <label class="help-inline">Password must contains at least 6 characters</label>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label"> Enter Password again:</div>
                <div class="controls ">
                    <div class="input-prepend input-append">
                        <input type="password" name="confirmnewpassword" placeholder="Enter password">
                    </div>
                    <label class="help-inline">Passwords must match</label>
                </div>
            </div>
            <div class="control-group">
                <div class="controls">
                    <input type="button" id="saveButton" class="btn input-medium btn-primary" value="Save Changes">
                </div>
            </div>
        </form>
    </div>
    <div class="row">
        <div>
            <div style="background-color: #ffffff; padding: 5px">
            </div>
            <div class="tabbable"> <!-- Only required for left/right tabs -->
                <ul class="nav nav-tabs">
                    <li class="active">
                        <a href="#tab1" data-toggle="tab">
                            Boards<span class="badge"><%= boards.length %></span>
                        </a>
                    </li>
                    <li>
                        <a href="#tab2" data-toggle="tab">
                            Flyers<span class="badge"><%= flyers.length %></span>
                        </a>
                    </li>
                    <li>
                        <a href="#tab3" data-toggle="tab">
                            Following<span class="badge"><%= followingBoards.length %></span>
                        </a>
                    </li>
                    <li>
                        <a href="#tab4" data-toggle="tab">
                            Ticketeds<span class="badge"><%= ticketedFlyers.length %></span>
                        </a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="tab1">
                        <div>
                            <ul class="thumbnails">
                                <% for(i=0;i<boards.length;i++){%>
                                <li class="span3 userboard" board-id="<%=boards[i]._id%>">
                                    <a class="thumbnail" href="/board/<%=boards[i]._id%>">
                                        <h3 class="caption"><%=boards[i].name%></h3>
                                        <h5 class="caption"><%=boards[i].category%></h5>
                                        <h5 class="caption"><%=boards[i].privacy||''%></h5>
                                    </a>
                                </li>
                                <%}%>
                            </ul>
                        </div>
                    </div>
                    <div class="tab-pane" id="tab2">
                        <div>
                            <ul class="thumbnails">
                                <% for(var i=0;i<flyers.length;i++){%>
                                <li class="span5 userflyer" flyer-id="<%=flyers[i]._id%>">
                                    <div class="thumbnail">
                                        <a href="/flyer/<%=flyers[i]._id%>">
                                            <h3>
                                                <%=(flyers[i].flyer&&flyers[i].flyer.description)
                                                        ? flyers[i].flyer.description
                                                        : "untitled"%>
                                            </h3>
                                            <form action="/flyer/putup" method="post" class="form-inline">
                                                <div class="controls">
                                                    <a href="/flyer/remove/<%=flyers[i]._id%>">&times</a>
                                                    <input type="hidden" name="flyerid" value="<%=flyers[i]._id%>">
                                                    <select name="boardid">
                                                        <%for(var j=0;j<pBoards.length;j++){%>
                                                        <option value="<%=pBoards[j]._id%>"> <%=pBoards[j].name%> </option>
                                                        <%}%>
                                                    </select>
                                                    <button class="btn input-mini btn-danger" type="submit">pin it</button>
                                                </div>
                                            </form>
                                        </a>
                                    </div>
                                </li>
                                <%}%>
                            </ul>
                        </div>
                    </div>
                    <div class="tab-pane" id="tab3">
                        <div>
                            <ul class="thumbnails">
                                <% for(i=0;i<followingBoards.length;i++){%>
                                <li class="span3">
                                    <a class="thumbnail" href="/board/<%=followingBoards[i]._id%>">
                                        <h3 class="caption"><%=followingBoards[i].name%></h3>
                                        <h5 class="caption"><%=followingBoards[i].category%></h5>
                                        <h5 class="caption"><%=followingBoards[i].privacy||''%></h5>
                                    </a>
                                </li>
                                <%}%>
                            </ul>
                        </div>
                    </div>
                    <div class="tab-pane" id="tab4">
                        <div>
                            <ul class="thumbnails">
                                <% for(i=0;i<ticketedFlyers.length;i++){%>
                                <li class="span3">
                                    <% if( ticketedFlyers[i].isDeleted) { %>
                                    <h3 class="caption">A Deleted Flyer</h3>
                                    <% } else { %>
                                    <a class="thumbnail" href="/flyer/<%=ticketedFlyers[i].flyer._id%>">
                                        <h3 class="caption"><%=ticketedFlyers[i].flyer.flyer.description%></h3>
                                    </a>
                                    <% } %>
                                </li>
                                <%}%>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
