<% layout('layout.ejs') %>

<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript" src="http://almende.github.io/chap-links-library/js/timeline/timeline.js"></script>
<link rel="stylesheet" type="text/css" href="http://almende.github.io/chap-links-library/js/timeline/timeline.css">


<script src="/script/jquery.watable.js" type="text/javascript" charset="utf-8"></script>
<link rel='stylesheet' href='/css/watable.css'/>
<link rel='stylesheet' href='/css/dashboard.css'>
<link rel='stylesheet' href='/css/job.css'>

<script>
var teamID = '<%=teamID%>';
var userID = '<%=userID%>';
var teamMembers = [];
var forms = [];

google.load("visualization", "1");

$(function(){
    // First fill Forms list, then fill table according to current selected form
    fillFormsList( fillTable );
    getStat();
    getTeamInfo();
    getInvitatinos();

    $('#formsList').change( function() {
        fillTable();
        selectAssignedToFromList();
    });

    $('#viewForm').click( function() {
        var flyerid = $('#formsList :selected').attr('id')
        window.open('/flyer/view/0?flyerid=' + flyerid);
    });

    $('#editForm').click( function() {
        var flyerid = $('#formsList :selected').attr('id')
        window.open('/flyer/edit/0?flyerid=' + flyerid);
    });

    $('#inactiveForm').click( function() {
        var flyerid = $('#formsList :selected').attr('id')
        $.post('/flyer/inactive', {flyerID:flyerid}).done(function(){
            fillFormsList();
        });
    });

    $('#activitiesModal').dialog({
        resizable: false,
        autoOpen: false,
        modal: true,
        title: "Activities",
        width: 800,
        height: 450
    });
});

function fillFormsList( callback ) {

    $('#formsList option').remove();

    $.get('/api/forms?teamID=' + teamID).done( function(res) {

        forms = res.forms;

        res.forms.forEach( function(form) {
            var option = $('<option>').text(form.formName + form.mode ).attr('id',form.formID);
            $('#formsList').append(option);
        });

        callback();
    })
}

function fillTable() {

    selectAssignedToFromList();

    var selectedForm = $('#formsList :selected');
    var qsParams = '?userID='  + userID + '&teamID='  + teamID + '&formID=' + selectedForm.attr('id');

    $('#currentFormName').text( selectedForm.val() );

    $('#formsTable').html('');

    $('#formsTable').WATable({
        url: '/api/applications' + qsParams,
        preFill: true,
        pageSize: 10,
        sorting: true,
        filter: true,
        sortEmptyLast: true,
        hidePagerOnEmpty: true,
        checkboxes: true,
        actions: {
            filter: true, //Toggle visibility
            columnPicker: true, //Toggle visibility
            custom: [
                $('<a href="#">someLink</a>'),
                $('<a href="#">anotherLink</a>')
            ]
        },
        rowClicked: function(data) {
            rowClicked(data);
        }
    });
}

// Make a triple parameters function
function handlerMaker(a,b,c) {
    return (function(p1,p2,p3){
        return function(){changeApplicationState(p1,p2,p3)}
    })(a,b,c);
}

function changeApplicationState(appID,newState,inputElements) {

    var data = {};

    for(var i=0; i<inputElements.length; i++)
        data[ inputElements[i].attr('name') ] = inputElements[i].val();

    $.post( '/api/applications/' + appID, { activity:newState, data:data }).done( function(res) {
        fillTable();
    })
}

function Application(appID) {
    $.post( '/api/applications/' + appID, {
        activity:'INVITED'
    }).done( function(res) {
                fillTable();
            })
}

function getStat() {
    $.get('/api/applications/stat').done( function(res){
        $('#numForms').text( res.numForms )
        $('#numApplications').text( res.numApplications )
        $('#numNewApplications').text( res.numNewApplications )
        $('#numTodayApplications').text( res.numTodayApplications )
    });
}

function rowClicked(data) {

    var activities = $('<div>').addClass('activities');
    var appID = data.row._id;
    var timelineRows = [];

    for( var i=0; i<data.row.activities.length; i++ ) {
        var activity = data.row.activities[i];
        var dateTime = new Date(activity['timestamp']);

        var activityItem = $('<div>').addClass('activity');
        var timeStamp = $('<div>').addClass('activity-timestamp').text( dateTime.toLocaleString() );
        var activityType = $('<div>').addClass('activity-type').text( activity['type'] );
        var separator = $('<hr>').addClass('activity-separator');

        var aboutDecision ='';

        if( i > 0 ) {
            var decisionTitle = $('<div>').append('Decision: ' +  data.row.activities[i-1]['type'] + ' &#10140; ' + data.row.activities[i]['type']);
            var decisionBody = $('<div>');

            var moreData = data.row.activities[i].data;
            for( var key in moreData)
                decisionBody.append('<b>' + key + '</b>' + ': ' + moreData[key] + '<br/>');

            aboutDecision = $('<div>')
                    .addClass('activity-decision')
                    .append(decisionTitle)
                    .append(decisionBody);
        }

        activityItem
                //.append(separator)
                .append(timeStamp)
                .append(activityType)
                .append(aboutDecision)

        activities.prepend( activityItem );

        timelineRows.push([dateTime,, activity['type']]);

    }

    $('#activitiesModal').find('.contain').html( activities );
    $('#activitiesModal').dialog('open');

    // Showing timeline must be called just after removing hidden property
    loadTimeline(timelineRows);

    var lastActivity = data.row.activities[ data.row.activities.length-1 ];
    loadDecisionBox( lastActivity, appID );

    // AskForComment section
    $('#askForCommentOnApplication').click( function() {
        $.post('/application/askForComment', {userID:'SELECETED USER',applicatinoID:'SELECTED APPLICATION'});
    });

    for( var i=0; i<teamMembers.length; i++ ){
        var option = $('<option>')
                .attr('name',teamMembers[i]._id)
                .attr('id',teamMembers[i]._id)
                .text(teamMembers[i].email);
        $('#teamMembersForAssign').append( option.clone() );
        $('#teamMembersForComment').append( option.clone() );
    }
}

function loadDecisionBox(activity,applicationID) {

    $('#decisionBox').html('');

    var actionPanel = $('<div>').addClass('activity-actionPanel');
    var currentState = $('<p>').html('This application is in <b>' + activity['type'] + '</b> state.').addClass('activity-title');
    var title = $('<p>').text('Make a decision').addClass('activity-title');
    var note = $('<textarea>').attr('placeholder','Enter a note about your decision causes')
            .addClass('activity-note')
            .attr('name','note') ;
    actionPanel.append(currentState).append(title).append(note).append('<br>');

    switch( activity['type'] ) {
        case 'NEW':
            var ignoreBtn = $('<button>')
                    .text('Ignore')
                    .addClass('btn btn-danger')
                    .click( handlerMaker(applicationID,'IGNORED',[note]) );

            var planBtn = $('<button>')
                    .text('Plan an interview')
                    .addClass('btn btn-primary')
                    .click( handlerMaker(applicationID,'PLANNING',[note]) );

            actionPanel.append(ignoreBtn).append(planBtn);
            break;
        case 'PLANNING':
            var interviewDate = $('<input type=date>')
                    .attr('name','interviewDate');
            var interviewTime = $('<input type=time>')
                    .attr('name','interviewTime')

            var ignoreBtn = $('<button>')
                    .text('Ignore')
                    .addClass('btn btn-danger')
                    .click( handlerMaker(applicationID,'IGNORED',[note]) );

            var inviteBtn = $('<button>')
                    .text('Send an invitation')
                    .addClass('btn btn-primary')
                    .click( handlerMaker(applicationID,'INVITED',[note,interviewDate,interviewTime]) );

            actionPanel.append(interviewDate)
                    .append(interviewTime)
                    .append('<br>')
                    .append(ignoreBtn)
                    .append(inviteBtn);
            break;
        case 'INVITED':
            var ignoreBtn = $('<button>')
                    .text('Approved')
                    .addClass('btn btn-success')
                    .click( handlerMaker(applicationID,'APPROVED',[note]) );

            var inviteBtn = $('<button>')
                    .text('Decline')
                    .addClass('btn btn-danger')
                    .click( handlerMaker(applicationID,'DECLINED',[note]) );

            actionPanel.append(ignoreBtn).append(inviteBtn);
            break;
        case 'APPROVED':
        case 'DECLINED':
        case 'IGNORED':
            var BackToListBtn = $('<button>')
                    .text('Back to list')
                    .addClass('btn btn-primary')
                    .click( handlerMaker(applicationID,'NEW',[note]) );
            actionPanel.append(BackToListBtn);
            break
    }

    $('#decisionBox').append(actionPanel)
}

function loadTimeline(rows) {

    // Create and populate a data table.
    var data = new google.visualization.DataTable();
    data.addColumn('datetime', 'start');
    data.addColumn('datetime', 'end');
    data.addColumn('string', 'content');

    data.addRows(rows);

    // specify options
    var options = {
        "width":  "500px",
        "height": "200px",
        "style": "box",
        "showCurrentTime": true
    };

    // Instantiate our timeline object.
    var timeline = new links.Timeline(document.getElementById('timeline'));

    // Draw our timeline with the created data and options
    timeline.draw(data, options);
}

function getInvitatinos() {
    $.get('/api/user/invitations').done( function(res){

        for( var i=0; i<res.length; i++ ) {
            var response = confirm( res[i].inviterTeam.name + ' team have invited you. Do you like to join them?' );
            if( response )
                $.post('/api/user/team/join',
                        {teamID:res[i].inviterTeam._id})
                        .done( function(res) {
                            alert('You joint');
                        })
        }
    });
}

function getTeamInfo() {
    $.get('/api/user/team').done( function(res){
        $('#teamName').text( res.team.name );
        $('#teamAdmin').text( res.team.admin.email );

        teamMembers = res.team.members;

        for( var i=0; i<res.team.members.length; i++ ){
            $('#teamMembers').append( $('<div>').text(res.team.members[i].email) );

            var option = $('<option>').attr('name',res.team.members[i]._id).attr('id',res.team.members[i]._id).text(res.team.members[i].email);
            $('#assignTo').append( option );
        }

        selectAssignedToFromList();

        $('#assignTo').change( function(e,item,r){
            var userID = $('#assignTo :selected').attr('id')
            var formID = $('#formsList :selected').attr('id')

            $.post('/api/team/form/assign',{formID:formID,userID:userID})
        })
    });

    $('#inviteToTeam').click( function() {
        $.post('/api/team/invite',{ email: $('#inviteEmail').val() });
    });
}

function selectAssignedToFromList() {
    var selectedFormID = $('#formsList :selected').attr('id');

    forms.forEach( function(form) {
        if( form.formID == selectedFormID )
            $('#assignTo option[name=' + form.assignedTo + ']').attr('selected','selected');
    });
}

function saveTeamInfo() {
    $.put('/api/user/team').done( function(res){})
}

</script>

<div id="wrap">
    <div class="container">
        <div clas="row">
            <div class="span12">
                Team: <span id="teamName"></span>
                Admin: <span id="teamAdmin"></span>
            </div>
        </div>

        <div clas="row">
            <div class="span12">
                <div id="teamMembers"></div>
            </div>
        </div>

        <div clas="row">
            <div class="span12">
                <input type="email" id="inviteEmail" placeholder="yourfriend@yourorg.com">
                <button id="inviteToTeam">Invite</button>
            </div>
        </div>

    </div>

    <div class="container">

        <div class="row-fluid statisticsRow">
            <div class="span3 statBox">
                <div class="number" id="numForms"></div>
                <div class="text">Open Position</div>
            </div>

            <div class="span3 statBox">
                <div class="number" id="numApplications"></div>
                <div class="text">Applications</div>
            </div>

            <div class="span3 statBox">
                <div class="number" id="numNewApplications"></div>
                <div class="text">Unvisited Applications</div>
            </div>

            <div class="span3 statBox">
                <div class="number" id="numTodayApplications"></div>
                <div class="text">Today Applications</div>
            </div>
        </div>

        <div class="row-fluid toolbarRow">
            <div class="span2">
                <span class="formsListLabel">Forms:</span>
            </div>
        </div>

        <div class="row-fluid toolbarRow">
            <div class="span7">
                <div class="formName">
                    <select id="formsList"></select>
                    <select id="assignTo"></select>
                </div>
            </div>
            <div class="span5">
                <button class="btn btn-warning btn-large" id="inactiveForm">Inactive Form</button>
                <button class="btn btn-primary btn-large" id="viewForm">View Form</button>
                <button class="btn btn-success btn-large" id="editForm">Edit Form</button>
            </div>
        </div>

        <div class="row-fluid tableRow">
            <div class="span12">
                <div id="tableTitle">Application related to <span id="currentFormName">-</span>:</div>
                <div id="formsTable"></div>
            </div>
        </div>

    </div>
</div>

<div id="activitiesModal">
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span6">
                <select id="teamMembersForComment">
                </select>
                <button id="askForCommentOnApplication">Ask For Comment</button>
            </div>
            <div class="span6">
                <select id="teamMembersForAssign">
                </select>
                <button id="assignToOnApplication">Assign To</button>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span4">
                <div class="contain" style="max-height: 400px; overflow-y: auto"></div>
            </div>
            <div class="span8">
                <div id="timeline"></div>
                <div id="decisionBox"></div>
            </div>
        </div>
    </div>
</div>