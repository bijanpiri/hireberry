<% layout('layout') -%>

<link rel="stylesheet" href="http://abpetkov.github.io/switchery/dist/switchery.min.css" />
<script src="http://abpetkov.github.io/switchery/dist/switchery.min.js"></script>

<link rel="stylesheet" href="http://welldonethings.com/managed/tagmanager.css">
<script src="http://welldonethings.com/managed/tagmanager.js"></script>

<link href="http://hallojs.org/css/font-awesome/css/font-awesome.css" rel="stylesheet" />
<script src="http://rangy.googlecode.com/svn/trunk/currentrelease/rangy-core.js"></script>
<script src="http://hallojs.org/js/hallo.js"></script>

<script src="/script/jquery.jcarousel.min.js"></script>
<script src="/script/jquery.cookie.js"></script>
<script src="https://apis.google.com/js/plusone.js"></script>

<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyB9JJKEbOztuSVauWEU58UeQJWtuzip2eU&sensor=false"></script>
<script src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markermanager/src/markermanager.js"></script>

<script src="/script/Widgets/Widget.js"></script>
<script src="/script/Widgets/TextWidget.js"></script>
<script src="/script/Widgets/PictureWidget.js"></script>
<script src="/script/Widgets/VideoWidget.js"></script>
<script src="/script/Widgets/VoiceWidget.js"></script>
<script src="/script/Widgets/WorkTypeWidget.js"></script>
<script src="/script/Widgets/MapWidget.js"></script>
<script src="/script/Widgets/ButtonWidget.js"></script>
<script src="/script/Widgets/AnythingElseWidget.js"></script>
<script src="/script/Widgets/PersonalInfoWidget.js"></script>
<script src="/script/Widgets/ProfilesWidget.js"></script>
<script src="/script/Widgets/ResumeWidget.js"></script>
<script src="/script/Widgets/SeperatorWidget.js"></script>
<script src="/script/Widgets/SkillWidget.js"></script>
<script src="/script/Widgets/WorkTypeWidget.js"></script>
<script src="/script/Widgets/BadgeWidget.js"></script>

<script src="/script/Widgets/flyer.js"></script>

<div id="fb-root"></div>
<script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=241341676042668";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

<!--
<style>
    input[type='text'].tt-hint{
        display: none;
    }
</style>
-->
<!--<script src="/jquery.putup-panel.js"></script>
<script>
    $(function(){
        $("#flyer-putup").height(400).putupPanel();
    })

</script>-->
<script>
    var flyerJson;
    var flyerid;
    var checkboxesList = [];
    $(function(){

        /* var tagApi;
         tagApi = jQuery("#boardNamesList").tagsManager();//{

         $.getJSON('/board/get/public',function(boards){
         $.each(boards,function(index,boardnn){
         if( boardnn.locationlng && boardnn.locationlat){
         tagApi.tagsManager(
         "pushTag",boardnn.name
         )
         }
         })
         });*/

        /*
         jQuery("#boardNamesList").typeahead({
         name: 'boards',
         limit: 15,
         valueKey: 'display',
         remote: '/search/boards/name?q=%QUERY'
         }).on('typeahead:selected', function (e, d) {
         tagApi.tagsManager("pushTag", d.display);
         });


         map = L.mapbox.map('map', 'coybit.gj1c3kom',{
         doubleClickZoom: false
         }).setView([37.9, -77],6);*/



        var switchsList = $('input[type=checkbox]')
        switchsList.each(function(idx){
            checkboxesList[idx] = new Switchery(switchsList[idx]);
        })

        $('.switchery').addClass('pull-right')

        $('.row-fluid .switchery').css('margin-top','10px').css('text-','10px')

        // Save Flyer Proeprties
        $('#buttonDone').click(function(){

            $('#buttonDone').addClass('disabled');

            flyerJson.description = $('#description').val();
            flyerJson.disqusShortname = $('#disqussShortname').val();

            var facebook = checkboxesList[0].isChecked();
            var twitter = checkboxesList[1].isChecked();
            var googleplus = checkboxesList[2].isChecked();
            var reshare = checkboxesList[3].isChecked();
            var reputup = checkboxesList[4].isChecked();
            flyerJson.tags=$('input.tags').val().split(',');


            $.post( '/flyer/publish', {flyer:flyerJson} )
                    .done(function(data){
                        $.removeCookie('flyerid',{path:'/'});
                        $('#buttonDone').removeClass('disabled');
                        window.location = '/profile';
                    })
                    .fail(function(data){
                        $('#buttonDone').removeClass('disabled');
                    });
        });

        // Load Flyer Properties
        flyerid = $('input[name=flyerid]').val();

        $().Flyer({}).json2flyer(flyerid, function(json){
            flyerJson = json;
            $('#flyerThumbnail').attr('src',json.thumbnail);
            $('#description').val(json.description);
            $('#disqussShortname').val(json.disqusShortname);
        });


    });




</script>
<!--<script>

    $(document).ready(main);
    function submit(){
        $("input#tag").tagsinput('items');
    }

    var marker;
    var map;
    function fillCategory(){
        $.get('/board/categories',
                function(cats){
                    var options=$('select.categories');
                    $.each(cats,
                            function(i,cat){
                                options.append(
                                        $('<option>').attr('name',cat.id).append(
                                                cat.name
                                        )
                                );

                            });
                });
    }

    function main(){
        fillCategory();



        $.getJSON('/board/get/public',function(boards){
            var geoJson= new Array();
            $.each(boards,function(index,boardnn){

                if( boardnn.locationlng && boardnn.locationlat) {
                    geoJson.push({
                        type: 'Feature',
                        geometry:{
                            type:'Point',
                            coordinates:[boardnn.locationlng,boardnn.locationlat]
                        },
                        properties: {
                            title: boardnn.name,
                            description: boardnn.category,
                            'marker-size': 'large',
                            'marker-color': 'CC0033'
                        }
                        // draggable: true
                    })
                }
            });
            map.markerLayer.setGeoJSON(geoJson);
        });




    }

    function locationError(msg) {
//    if(msg==null)
//        msg='Failed to find location. Allow your browser to access your location.';
        $('#msgLocationError>.msg').text(msg.message).parent().show();
    }


    function ErrorMsg(msg) {
        $('.message-error').show();
        $('.message-error>.msg-error').text(msg);
    }

    function locationFound(e) {
        map.fitBounds(e.bounds);
        marker.setLatLng(e.latlng);


    }

</script>-->



<script>
    var map;
    var mycenter;
    var boards = [];
    var markers;
    var markersarray=[];
    var infowindow;
    var boardname;
    var titleaddtotagslist;
    var markercolor;
    var boardidtotags;
    var items=[];
    var idarray=[];
    var removedvalue;
    function initialize(){
        var map_property = {
            center: new google.maps.LatLng(51.508742,-0.120850),
            zoom: 5,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),map_property);
        getLocation();

    }
    function getLocation(){
        markers = new MarkerManager(map);
        $.getJSON('/board/public',function(publicBoards){
            $.each(publicBoards,function(index,board){
                if(board.locationlat && board.locationlng){
                    boards.push(board);
                    var marker = new google.maps.Marker({
                        type:'Feature',
                        icon:'http://maps.google.com/mapfiles/ms/icons/purple-dot.png',
                        position: new google.maps.LatLng(board.locationlat,board.locationlng),
                        map: map,
                        'result':[{"address_components":[{
                            'title':board.name,
                            'boardIndex':index,
                            'description':board.category,
                            'icon':{
                                'size':new google.maps.Size(32,32),
                                'color':'522'
                            }

                        }]
                        }]

                    });
                    marker.title=board.name;
                    marker.boardid=board._id;
                    markers.addMarker(marker);
                    markersarray.push(marker);
                }

                items.push({value:board._id,text:board.name,marker:marker});
            });

            markers.refresh();
            try{
                $.each(markersarray,function(index,marker){
                    google.maps.event.addListener(marker,'click',function(e){
                        titleaddtotagslist = marker.title;
                        boardidtotags = marker.boardid;
                        idarray=$('#tags-input').val().split(',');
                        var flag=false;

                        for(var i=0;i<idarray.length;i++){
                            if(idarray[i]==boardidtotags ){
                                removedvalue=boardidtotags;
                                $('#tags-input').tagsinput('remove',{value:boardidtotags});
                                marker.setIcon('http://maps.google.com/mapfiles/ms/icons/purple-dot.png');
                                flag=true;
                            }
                        }
                        if(flag==false){
                            $('#tags-input').tagsinput('add',{"value":boardidtotags,"text":titleaddtotagslist,marker:marker});
                            marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');

                        }

                    });
                });
                $("#tags-input").on('itemAdded', function(event) {
                    event.item.marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
                });
                $("#tags-input").on('itemRemoved', function(event) {
                    event.item.marker.setIcon('http://maps.google.com/mapfiles/ms/icons/purple-dot.png');
                });

                markers.setMap(map);

            }catch (e){
                console.log(e);
            }
        });

    }
    google.maps.event.addDomListener(window, 'load', initialize);
</script>
<script>
    $(document).ready(function(){
        $('#tags-input').tagsinput({
            itemValue: function (item) {
                return item.value;
            },
            itemText: function (item) {
                return item.text;
            },
            typeahead:{
                source:items
            }
        });
        /*for(var i=0;i<idarray.length;i++){
         if(idarray[i]!==removedvalue)
         marker.setIcon('http://maps.google.com/mapfiles/ms/icons/purple-dot.png');
         }*/

    });
</script>

<div class="container-fluid">


    <div class="row-fluid" style="margin-bottom: 30px;">
        <div class="span12">

            <div>
                <input id="tags-input" type="text"/>
            </div>
            <div id="map-canvas" style="width:500px;height:380px;"></div>


        </div>
    </div>
    <div class="row-fluid" style="margin-bottom: 30px;">
        <div class="span9 offset1" style="background-color: #555; color: #fff; line-height: 25px; padding-left:10px ">
            STEP 1 > STEP2 > <b>STEP3. Publish your flyer</b>
            <a href="/flyer/editor" class="btn btn-success pull-right">Back</a>
            <a href="#" id="buttonDone" class="btn btn-success pull-right">Done</a>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span3 offset1">
            <div class="container-fluid">
                <div class="row-fluid">
                    <form>
                        <fieldset>
                            <legend>publish options:</legend>
                            <div class="control-group">
                                <div class="control-label"> Tags:</div>
                                <div class="controls ">
                                    <input class="htags" name='tags' type="hidden" />
                                    <input class="tags"  type="text" data-role="tagsinput" />

                                    <!--<label class="help-inline"></label>-->
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
                <div class="row-fluid">
                    <div class="span12">
                        <input type="hidden" name="flyerid" value="<%=flyerid%>"/>
                        <input type="text" id="description" placeholder="Enter a title" style="width: 100%">
                    </div>
                </div>
                <div class="row-fluid"><div class="span12"><b>Share on:</b></div></div>
                <div class="row-fluid"><div class="span10 offset2">Facebook<input type="checkbox" class="js-switch pull-right"></div></div>
                <div class="row-fluid"><div class="span10 offset2">Twitter<input type="checkbox" class="js-switch pull-right"></div></div>
                <div class="row-fluid"><div class="span10 offset2">Google+<input type="checkbox" class="js-switch pull-right"></div></div>
                <div class="row-fluid"><div class="span12"><b>Other Options:</b></div></div>
                <div class="row-fluid"><div class="span10 offset2">Comment<input type="text" id="disqussShortname" class="pull-right input-medium" placeholder="disqus shortname"></div></div>
                <div class="row-fluid"><div class="span10 offset2">Reshare<input type="checkbox" class="pull-right"></div></div>
                <div class="row-fluid"><div class="span10 offset2">Reput-up<input type="checkbox" class="pull-right"></div></div>
                <div class="row-fluid"><div class="span10 offset2"><g:plus action="share" href="http://booltin.herokuapp.com/flyer/<%=flyerid%>"></g:plus> </div></div>
                <div class="row-fluid"><div class="span10 offset2"><div class="fb-share-button" data-href="http://booltin.herokuapp.com/flyer/<%=flyerid%>" data-type="button_count"></div> </div></div>
                <div class="row-fluid"><div class="span10 offset2"><a href="https://twitter.com/share" class="twitter-share-button" data-lang="en" data-url="http://booltin.herokuapp.com/flyer/<%=flyerid%>" data-text="Here is my flyer" >Tweet</a></div> </div></div>
            </div>
        </div>

        <div class="span6">
            <div class="container-fluid">
                <div class="row-fluid" style="margin: 20px">
                    <img width="300px" id="flyerThumbnail">
                </div>
                <!-- <div class="row-fluid">
                     <div class="span12" style="border: 1px solid #000;padding: 5px 0 0 5px;">
                         <input type="text" name="tags" placeholder="Board Name" class="tm-input" id="boardNamesList"/>
                     </div>
                 </div>
                 <div class="row-fluid">
                     <div class="span12" style="border: 1px solid #000;">
                         <div id="map" style="height: 400px;"></div>
                     </div>
                 </div>-->
                <!--<div class="row-fluid" id="flyer-putup" >-->

                </div>
            </div>
        </div>

    </div>
</div>