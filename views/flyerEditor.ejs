<% layout('layout') -%>


<script src="/jquery-ui/js/file_upload.js"></script>

<script src="http://cburgmer.github.io/rasterizeHTML.js/rasterizeHTML.allinone.js"></script>

<script src="/html2canvas.js"></script>
<link href="/css/flyer.css" rel="stylesheet">
<link href="http://hallojs.org/css/font-awesome/css/font-awesome.css" rel="stylesheet" />
<script src="http://rangy.googlecode.com/svn/trunk/currentrelease/rangy-core.js"></script>
<script src="http://hallojs.org/js/hallo.js"></script>

<script src="/script/jquery.jcarousel.min.js"></script>
<script src="/flyer.js"></script>
<script>
    var flyer;
    var flyerid;
    var previewWindow = 0;

    function changeBackground() {
        $('#backgroundImage').click();
    }

    function shot(){
        var canvas = document.getElementById("canvas");
        var flyerElem = $('.portletStack');

        //rasterizeHTML.drawHTML(flyerElem,canvas);

        html2canvas(flyerElem, {
            onrendered: function(canvas) {
                console.log( canvas.toDataURL() );
            }
        });
    }

    $(function() {
        $('.jcarousel').jcarousel();
        flyerid = $('input[name=flyerid]').val();
        flyer = $('.portletStack').Flyer({
            editMode:true,
            flyerid:flyerid
        });




        $('#portletCreatorAlarm').hallo();

        $('#buttonPreview').click( function() {

            var flyerid = $('input[name=flyerid]').val();

            if( previewWindow==0 )
                previewWindow = window.open('/flyer/' + flyerid);
            else
                previewWindow.location = '/flyer/' + flyerid;
        })

        $('#buttonSave').click(function(){

            $('#buttonSave').text('Saving...').addClass('disabled');

            var flyerElem = $('.portletStack');
            var flyerjson = flyer.flyer2json('portletStack');

            // Generate Thumbnail Image
            html2canvas(flyerElem, {
                onrendered: function(canvas) {
                    console.log( canvas.toDataURL() );

                    flyerjson.thumbnail = canvas.toDataURL();

                    $.post( '/flyer/new', {flyer:flyerjson} )
                            .done(function(data){
                                $('#buttonSave').text('Save').removeClass('disabled');
                            })
                            .fail(function(data){
                                $('#buttonSave').text('Save*').removeClass('disabled');
                            });
                }
            });
        });

        $('#backgroundImage').fileupload({
            url:'/flyer/upload',
            dataType: 'json',
            done: function (e, data) {
                flyer.setBackground( '/uploads/' + data.result.files[0].name , true );
            }
        });
    });

</script>

<div class="container-fluid" style="width: 95%;">
    <div class="row-fluid" style="margin-bottom: 30px;">
        <div class="span9 offset1" style="background-color: #555; color: #fff; line-height: 25px; padding-left:10px ">
            STEP 1 > <b>STEP2. Create Your Flyer </b> > STEP3</b>
            <a href="/flyer/publish/<%=flyerid%>" class="btn btn-success pull-right">Next</a>
            <a href="/flyer/template" class="btn btn-success pull-right">Back</a>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span3 offset1" style="margin-bottom: 10px;">
            <input type="hidden" name="flyerid" value="<%=flyerid%>"/>
            <input type="hidden" name="flyertext" placeholder="Enter Flyer Description" />
            <button type="button" class="btn btn-success" id="buttonSave">Save</button>
            <button type="button" class="btn btn-warning" id="buttonPreview">Preview</button>
            <span><%=templateID%></span>
        </div>
        <div class="span1 offset4">
            <button class="btn btn-warning" onclick="changeBackground()">Background</button>
            <input type="file" id="backgroundImage" hidden>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span6 offset2 portletsBox">
            <div class="portletStack">
            </div>
            <div class="portletCreator container-fluid">
                <div class="row-fluid text-center" id="portletCreatorAlarm" hidden>
                    Error: There is no space for adding new portlet!
                </div>
                <div class="row-fluid text-center">
                    <div class="span1 newitem" type="picture"><i class="icon-picture"></i></div>
                    <div class="span1 newitem" type="text"><i class="icon-font"></i></div>
                    <div class="span1 newitem" type="video"><i class="icon-facetime-video"></i></div>
                    <div class="span1 newitem" type="button"><i class="icon-globe"></i></div>
                    <div class="span1 newitem" type="tag"><i class="icon-tag"></i></div>
                    <div class="span1 newitem" type="map"><i class="icon-map-marker"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span8 offset2">
            <button onclick="shot()">SHOT</button>
            <canvas id="canvas" width="400" height="200" crossOrigin=""></canvas>
        </div>
    </div>

</div>




