<% layout('layout') -%>


<script src="/jquery-ui/js/file_upload.js"></script>

<script src="http://cburgmer.github.io/rasterizeHTML.js/rasterizeHTML.allinone.js"></script>

<script src="/html2canvas.js"></script>
<link href="/css/flyer.css" rel="stylesheet">
<link href="/css/font-awesome.css" rel="stylesheet" />
<script src="http://rangy.googlecode.com/svn/trunk/currentrelease/rangy-core.js"></script>
<script src="/script/hallo.js"></script>

<script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-image/v0.0.3/leaflet-image.js'></script>

<script src="/script/jquery.jcarousel.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script> <!-- Put Google Map just before flyer.js -->
<script src="/flyer.js"></script>

<script>
    var flyer;
    var flyerid;
    var previewWindow = 0;

    function changeBackground() {
        $('#backgroundImage').click();
    }

    function shot(){
        var canvas = document.getElementById("canvas");
        var flyerElem = $('.portletStack');

        //rasterizeHTML.drawHTML(flyerElem,canvas);

        html2canvas(flyerElem, {
            onrendered: function(canvas) {
                console.log( canvas.toDataURL() );
            }
        });
    }

    $(function() {
        $('.jcarousel').jcarousel();
        flyerid = $('input[name=flyerid]').val();
        flyer = $('.portletStack').Flyer({
            editMode:true,
            flyerid:flyerid
        });

        $('#portletCreatorAlarm').hallo();

        $('#buttonPreview').click( function() {

            var flyerid = $('input[name=flyerid]').val();

            if( previewWindow==0 )
                previewWindow = window.open('/flyer/' + flyerid);
            else
                previewWindow.location = '/flyer/' + flyerid;
        })

        $('#buttonSave').click(function(){

            $('#buttonSave').text('Saving...').addClass('disabled');

            var flyerElem = $('.portletStack');
            var flyerjson = flyer.flyer2json();

            flyer.getShot(function(image){

                flyerjson.thumbnail = image;

                $.post( '/flyer/save', {flyer:flyerjson} )
                        .done(function(data){
                            $('#buttonSave').text('Save').removeClass('disabled');
                        })
                        .fail(function(data){
                            $('#buttonSave').text('Save*').removeClass('disabled');
                        });
            });

            /*
             // Generate Thumbnail Image
             html2canvas(flyerElem, {
             onrendered: function(canvas) {
             console.log( canvas.toDataURL() );


             flyerjson.thumbnail = canvas.toDataURL();

             $.post( '/flyer/save', {flyer:flyerjson} )
             .done(function(data){
             $('#buttonSave').text('Save').removeClass('disabled');
             })
             .fail(function(data){
             $('#buttonSave').text('Save*').removeClass('disabled');
             });
             }
             });
             */
        });

        $('#backgroundImage').fileupload({
            url:'/flyer/upload',
            dataType: 'json',
            done: function (e, data) {
                flyer.setBackground( '/uploads/' + data.result.files[0].name , true );
            }
        });

        $('#plusButton').click(function(){
            $('#plusButton').hide();
            $('#addButtons').show();
        });

        $('.closeButton').click(function(){
            $('#plusButton').show();
            $('#addButtons').hide();
        });

        function rotate(element, degree) {
            element.animate({
                '-webkit-transform': 'rotate(' + degree + 'deg)',
                '-moz-transform': 'rotate(' + degree + 'deg)',
                '-ms-transform': 'rotate(' + degree + 'deg)',
                '-o-transform': 'rotate(' + degree + 'deg)',
                'transform': 'rotate(' + degree + 'deg)',
                'zoom': 1
            }, 5000);
        }
    });

</script>

<div class="container-fluid" style="width: 95%;">
    <div class="row-fluid" style="margin-bottom: 30px;">
        <div class="span9 offset1" style="background-color: #555; color: #fff; line-height: 25px; padding-left:10px ">
            STEP 1 > <b>STEP2. Create Your Flyer </b> > STEP3</b>
            <a href="/flyer/publish/<%=flyerid%>" class="btn btn-success pull-right">Next</a>
            <a href="/flyer/template" class="btn btn-success pull-right">Back</a>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span3 offset1" style="margin-bottom: 10px;">
            <input type="hidden" name="flyerid" value="<%=flyerid%>"/>
            <input type="hidden" name="flyertext" placeholder="Enter Flyer Description" />
            <button type="button" class="btn btn-success" id="buttonSave">Save</button>
            <button type="button" class="btn btn-warning" id="buttonPreview">Preview</button>
            <span><%=templateID%></span>
        </div>
        <div class="span1 offset4">
            <button class="btn btn-warning" onclick="changeBackground()">Background</button>
            <input type="file" id="backgroundImage" hidden>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span6 offset2" id="portletsBox">
            <div class="portletStack">
            </div>
            <div class="portletCreator container-fluid">
                <div class="row-fluid text-center" id="portletCreatorAlarm" hidden>
                    Error: There is no space for adding new portlet!
                </div>

                <div class="row-fluid" id="plusButton">
                    <div style="width: 84px; height: 64px;margin: 0 auto;">
                        <a class="buttonFrame plusButtonFrame">
                            <i class="button centeralBackgroundImage plusButton "></i>
                        </a>
                    </div>
                </div>
                <div class="row-fluid" id="addButtons" hidden>
                    <div style="margin: 0 auto;position: relative;width: 612px;">
                        <a class="newitem buttonFrame" type="1">
                            <i class="button centeralBackgroundImage addNewTextButton"></i>
                        </a>
                        <a class="newitem buttonFrame" type="2">
                            <i class="button centeralBackgroundImage addNewPhotoButton"></i>
                        </a>
                        <a class="newitem buttonFrame" type="3">
                            <i class="button centeralBackgroundImage addNewVideoButton"></i>
                        </a>
                        <a class="newitem buttonFrame">
                            <i class="button centeralBackgroundImage closeButton"></i>
                        </a>
                        <a class="newitem buttonFrame" type="7">
                            <i class="button centeralBackgroundImage addNewVoiceButton"></i>
                        </a>
                        <a class="newitem buttonFrame" type="4">
                            <i class="button centeralBackgroundImage addNewLinkButton"></i>
                        </a>
                        <a class="newitem buttonFrame" type="6">
                            <i class="button centeralBackgroundImage addNewMapButton"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="widgets">
    <div class="textWidget">
        <div class="setPanel gray">
            <div class="leftPanel">
                <div class="b-group">
                    <label for="headline" class="b-addon ">
                        <input id="headline" name="type" hidden="hidden"  type="radio">
                        <div class="circle out">
                            <div class="circle in "></div>
                        </div>
                    </label>
                    <label  class="radio-label b-icon-container" for="headline" >
                        Headline
                        <i class="r-icon b-icon-align-center radio-label-icon"></i>
                    </label>
                </div>

                <div class="b-group">
                    <label for="text" class="b-addon ">
                        <input id="text" name="type" hidden="hidden"  type="radio">
                        <div class="circle out">
                            <div class="circle in "></div>
                        </div>


                    </label>
                    <label  class="radio-label" for="text" >
                        Text
                        <i class="r-icon b-icon-align-left radio-label-icon"></i>

                    </label>
                </div>

                <div class="bbtn-group">

                    <input class="bbtn bbtn-radio leftAlign" id='leftAlign' type="radio" name="align">
                    <label for="leftAlign" class="bbtn-label b-icon-container ">
                        <i class="b-icon b-icon-align-left" ></i>
                    </label>

                    <input class="bbtn bbtn-radio centerAlign" id='centerAlign' type="radio" name="align">
                    <label for="centerAlign" class="bbtn-label btn-Margin b-icon-container ">
                        <i class="b-icon b-icon-align-center" ></i>
                    </label>

                    <input class="bbtn bbtn-radio rightAlign" id='rightAlign' type="radio" name="align">
                    <label for="rightAlign" class="bbtn-label b-icon-container ">
                        <i class="b-icon b-icon-align-right" ></i>
                    </label>

                </div>

            </div>
            <div class="rightPanel">
                <div class="yellow"></div>
            </div>

        </div>


    </div>

    <div class="mapWidget">
        <div id="map-canvas" style="height: 100%"></div>
        <div id="panel" style="position: absolute;left: 0;right: 0;top:0;margin: 0 auto;width: 300px;">
            <input id="address" type="textbox" value="Sydney, NSW">
            <input type="button" value="Geocode" id="Getcode">
        </div>
    </div>
</div>



